---
title: "Week 4 figures - Lectures 7 and 8"
editor: source
freeze: auto
execute:
  message: false
  warning: false
format:
  html: 
    code-fold: true
author:
  - name: An Bui
    url: https://an-bui.com/
    affiliation: UC Santa Barbara, Ecology, Evolution, and Marine Biology
    affiliation-url: https://www.eemb.ucsb.edu/
published-title: "Lecture date"
date: 2024-04-21
date-modified: last-modified
categories: []
citation:
  url: https://spring-2024.envs-193ds.com/lecture/lecture_week-04.html
---


## 0. set up

```{r}
#| message: false

# cleaning
library(tidyverse)

# visualization
theme_set(theme_classic() +
            theme(panel.grid = element_blank(),
                  axis.text = element_text(size = 18),
                  axis.title = element_text(size = 18),
                  text = element_text(family = "Lato")))
library(patchwork)

# cohen's d
library(effectsize)

# power
library(pwr)
```

## 1. Math


### a. Cohen's d

$$
Cohen's \; d = \frac{\bar{y_A} - \bar{y_B}}{\sqrt{(s^2_A + s^2_B)/2}}
$$

### b. Cohen's d with separated SD

$$
Cohen's \; d = \frac{\bar{y_A} - \bar{y_B}}{\sqrt{\frac{(n_A - 1)\times s^2_A + (n_B - 1)\times s^2_B}{n_A + n_B + 2}}}
$$



### b. confidence interval for two-sample t-test

$$
CI = (\bar{y_A} - \bar{y_B}) \pm t \times \sqrt{\frac{(n_A - 1)s_A^2 + (n_B - 1)s_B^2}{n_A+n_B-2}} \times \sqrt{\frac{1}{n_A}+\frac{1}{n_B}}
$$

### c. test statistic for paired t-test

$$
t_s = \frac{\bar{y}_d - \mu_0}{s_d - \sqrt{n}}
$$

### d. standard error for two-sample t-test

If variances are not equal:

$$
SE_{\bar{y_A} - \bar{y_B}} = \sqrt{\frac{s_A^2}{n_A}+\frac{s_B^2}{n_B}}
$$

## 2. Interpret this output

You have two raised beds in which you're growing tomatoes. One bed is in the sun, but the other is in shade. You want to know if the weight of the tomatoes is different between beds. You measure 33 tomatoes from each bed.

```{r tomatoes}
tomatoes <- cbind(sunny = rnorm(n = 33, mean = 150, sd = 20),
                  shaded = rnorm(n = 33, mean = 130, sd = 10)) %>% 
  as_tibble() %>% 
  pivot_longer(cols = 1:2, names_to = "sun_level", values_to = "weight_g")

ggplot(data = tomatoes,
       aes(x = sun_level,
           y = weight_g)) +
  geom_jitter(width = 0.1)

var.test(weight_g ~ sun_level,
         data = tomatoes)

t.test(weight_g ~ sun_level,
       data = tomatoes,
       var.equal = FALSE)
```


## 3. Power analysis

```{r two-examples-power-analysis}
# higher power
pwr.t.test(n = NULL, d = 0.7, sig.level = 0.05, power = 0.95)

# lower power
pwr.t.test(n = NULL, d = 0.7, sig.level = 0.05, power = 0.80)
```

## 4. Write about this result

You have two worm compost bins: one in which you throw citrus peels, and the other in which you don’t. You’re curious to see if the citrus worms are bigger than the non-citrus worms. You measure 34 worms from each bin and find this result:

```{r worm-compost}
worms <- cbind(citrus = rnorm(n = 34, mean = 140, sd = 20),
               non_citrus = rnorm(n = 34, mean = 160, sd = 15)) %>% 
  as_tibble() %>% 
  pivot_longer(cols = 1:2, names_to = "compost_bin", values_to = "weight_g")

ggplot(data = worms,
       aes(x = compost_bin,
           y = weight_g)) +
  geom_boxplot()

var.test(weight_g ~ compost_bin,
         data = worms)

t.test(weight_g ~ compost_bin,
       data = worms,
       var.equal = FALSE)
```


## 5. Effect size examples

### a. large sample size, small difference

```{r small-vs-large-sample-size}
set.seed(1)
small <- cbind(a = rnorm(n = 10, mean = 10, sd = 2), 
               b = rnorm(n = 10, mean = 11, sd = 2)) %>% 
  as_tibble() %>% 
  pivot_longer(cols = 1:2, names_to = "group", values_to = "value")
t.test(value ~ group,
       data = small,
       var.equal = TRUE)

set.seed(1)
large <- cbind(a = rnorm(n = 100, mean = 10, sd = 2), 
               b = rnorm(n = 100, mean = 11, sd = 2)) %>% 
  as_tibble() %>% 
  pivot_longer(cols = 1:2, names_to = "group", values_to = "value")
t.test(value ~ group,
       data = large,
       var.equal = TRUE)
```


### b. needlegrass example

```{r needlegrass}
set.seed(1)
needlegrass <- cbind(ungrazed = rnorm(n = 35, mean = 80, sd = 10), 
                     grazed = rnorm(n = 35, mean = 77, sd = 5)) %>% 
  as_tibble() %>% 
  pivot_longer(cols = 1:2, names_to = "plot_type", values_to = "height_cm")

# plot without all the adjustments
ggplot(data = needlegrass,
       aes(x = plot_type,
           y = height_cm,
           color = plot_type)) +
  geom_point(position = position_jitter(width = 0.1, seed = 10),
             alpha = 0.2) +
  stat_summary(geom = "pointrange",
               fun.data = mean_cl_normal) 

# "finalized" plot
ggplot(data = needlegrass,
       aes(x = plot_type,
           y = height_cm,
           color = plot_type)) +
  geom_point(position = position_jitter(width = 0.1, seed = 10),
             alpha = 0.2) +
  scale_color_manual(values = c("darkgreen", "cornflowerblue")) +
  stat_summary(geom = "pointrange",
               fun.data = mean_cl_normal,
               size = 1,
               linewidth = 1) +
  labs(x = "Plot type",
       y = "Height (cm)") +
  theme(legend.position = "none")
```

Doing a t-test:

```{r}
var.test(height_cm ~ plot_type,
       data = needlegrass)
t.test(height_cm ~ plot_type,
       data = needlegrass,
       var.equal = FALSE)
```

Cohen's d:

```{r}
# pooled SD
cohens_d(height_cm ~ plot_type,
       data = needlegrass)

# unpooled SD
cohens_d(height_cm ~ plot_type,
       data = needlegrass, 
       pooled_sd = FALSE)

# by hand
needlegrass_sum <- needlegrass %>% 
  group_by(plot_type) %>% 
  reframe(
    mean = mean(height_cm),
    var = var(height_cm),
    n = length(height_cm)
  )

ya <- pluck(needlegrass_sum, 2, 1)
yb <- pluck(needlegrass_sum, 2, 2)
vara <- pluck(needlegrass_sum, 3, 1)
varb <- pluck(needlegrass_sum, 3, 2)
na <- pluck(needlegrass_sum, 4, 1)
nb <- pluck(needlegrass_sum, 4, 2)

# by hand

(ya - yb)/sqrt((vara + varb)/2)

(ya - yb)/sqrt(
  ((na - 1)*vara + (nb - 1)*varb)/(na + nb - 2)
)

```

